import { Injectable } from '@nestjs/common'

import { ProductService } from '@app/database'

@Injectable()
export class CartKeyboard {
   private totalOrderText = null
   private isUdate = false
   constructor(
      private productsRepo: ProductService
   ) {}
   // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –º–µ–Ω—é –ø—Ä–∏ –≤—Ö–æ–¥–µ –≤ —Å—Ü–µ–Ω–∞—Ä–∏–π
   async pushCartMenu(ctx) {
      this.totalOrderText = await this.totalOrderTextCalc(ctx)
      this.setDefaultTime(ctx)

      const submitMenu = await ctx.reply(
         this.totalOrderText, {
         parse_mode: 'HTML',
         reply_markup: {
            inline_keyboard: this.buttonsData(ctx)
         }
      })
      ctx.session.trash.push(submitMenu.message_id)
   }
   // –û–±–Ω–æ–≤–ª—è–µ–º –º–µ–Ω—é
   async updateMenu(userId, keyboardId, ctx) {
      try {
         await ctx.telegram.editMessageReplyMarkup(
            userId, keyboardId, null, {
               inline_keyboard: this.buttonsData(ctx)
            }
         )
      } catch (error) {
         console.log(error)
         console.log('–ú–µ–Ω—é –Ω–µ –æ–±–Ω–æ–≤–ª–µ–Ω–æ')
      }
   }
   // –ü–†–û–í–ï–†–ö–ê –£–°–õ–û–í–ò–ô –ü–†–ò –ò–ó–ú–ï–ù–ï–ù–ò–ò –í–†–ï–ú–ï–ù–ò
   // –ü—Ä–æ–≤–µ—Ä–∫–∞ –≤—Ä–µ–º–µ–Ω–∏ –æ—Ç–∫—Ä—ã—Ç–∏—è
   checkOpeningTime(updatedTime, ctx) {
      const updateDate = new Date(updatedTime)
      // –í–µ—Ä–æ–≤–µ—Ä—è–µ–º —á—Ç–æ –≤—ã–±—Ä–∞–Ω–Ω–æ–µ –≤—Ä–µ–º—è –Ω–µ –º–µ–Ω—å—à–µ —Ç–µ–∫—É—â–µ–≥–æ + 20 –º–∏–Ω, –∏ –Ω–µ –≤—ã–±—Ä–∞–Ω–æ "–ó–∞–≤—Ç—Ä–∞"
      if(ctx.session.cart.day !== 'day_tomorrow') {
         const currentTime = new Date()
         const currentTimePlus = new Date()
         currentTime.setMinutes(currentTime.getMinutes() + 10)
         if(updateDate < currentTimePlus) {
            ctx.session.cart.time = currentTimePlus
            ctx.answerCbQuery('–ù–µ–ª—å–∑—è —É–∫–∞–∑–∞—Ç—å –≤—Ä–µ–º—è –º–µ–Ω—å—à–µ —Ç–µ–∫—É—â–µ–≥–æ')
            return false
         }
      }
      // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –≤—ã–±—Ä–∞–Ω–Ω–æ–µ –≤—Ä–µ–º—è –Ω–µ –±–æ–ª—å—à–µ –≤—Ä–µ–º–µ–Ω–∏ –∑–∞–∫—Ä—ã—Ç–∏—è
      if(updateDate > this.openingHours.to) {
         ctx.answerCbQuery('–ú—ã —Ä–∞–±–æ—Ç–∞–µ–º –¥–æ 23:00', ctx)
         return false
      }
      // –ü—Ä–æ–≤–µ—Ä—è–µ–º —á—Ç–æ –≤—ã–±—Ä–∞–Ω–Ω–æ–µ –≤—Ä–µ–º—è –Ω–µ –º–µ–Ω—å—à–µ –≤—Ä–µ–º–µ–Ω–∏ –æ—Ç–∫—Ä—ã—Ç–∏—è + 20 –º–∏–Ω
      const openFrom = this.openingHours.from
      const minPlus = new Date(openFrom.setMinutes(openFrom.getMinutes() + 20))
      if(updateDate < minPlus) {
         ctx.answerCbQuery('–ú—ã —Ä–∞–±–æ—Ç–∞–µ–º c 12:00', ctx)
         return false
      }
      return true
   }
   // –ü—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ –≤—Ä–µ–º–µ–Ω–∏, —É–±–µ–∂–¥–∞–µ–º—Å—è —á—Ç–æ –º–µ–Ω—é —É–∂–µ –Ω–µ –≤–∏—Å–∏—Ç –±–æ–ª–µ–µ 20 –º–∏–Ω—É—Ç
   checkMenuLifeTime(ctx): Date {
      const currentTime = new Date()
      // –í—Ä–µ–º—è —Ä–∞–±–æ—Ç—ã + 20 –º–∏–Ω—É—Ç
      const maxOrderTime = new Date(currentTime.getTime() + 20 * 60000)
      const cartTime = new Date(ctx.session.cart.time)
      if(maxOrderTime > this.openingHours.to) {
         ctx.session.cart.time = this.openingHours.from
         ctx.session.cart.day = 'day_tomorrow'
         this.isUdate = true
         ctx.answerCbQuery('–û–Ω–ª–∞–π–Ω –∑–∞–∫–∞–∑ –º–æ–∂–Ω–æ —Å–¥–µ–ª–∞—Ç—å –º–∏–Ω–∏–º—É–º –∑–∞ 20 –º–∏–Ω—É—Ç –¥–æ –∑–∞–∫—Ä—ã—Ç–∏—è')
         return
      }
      // –ï—Å–ª–∏ —Ç–µ–∫—É—â–µ–µ –≤—Ä–µ–º—è –±–æ–ª—å—à–µ –≤—Ä–µ–º–µ–Ω–∏ –∫–æ—Ä–∑–∏–Ω–∞ –Ω–∞ 20 –º–∏–Ω, –æ–±–Ω–æ–≤–ª—è–µ–º –∫–æ—Ä–∑–∏–Ω—É
      if(currentTime > cartTime) {
         ctx.session.cart.time = new Date(maxOrderTime)
         this.isUdate = true
      }
      return new Date(ctx.session.cart.time)
   }
   // –û–ë–†–ê–ë–û–¢–ö–ê –ù–ê–ñ–ê–¢–ò–ô [+] / [-]
   // –ü—Ä–æ–≤–µ—Ä–∫–∞ –≤—Å–µ—Ö —É—Å–ª–æ–≤–∏–π –∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –≤—Ä–µ–º–µ–Ω–∏ –≤ –º–µ–Ω—é
   async updateTime(timeUnit, operator, ctx): Promise<boolean> {
      console.log(timeUnit, operator)
      this.isUdate = false
      // –°–≤–µ—Ä—è–µ–º –≤—Ä–µ–º—è –ø–æ–∫–∞–∑–∞ –º–µ–Ω—é –∏ –≤—Ä–µ–º—è –Ω–∞–∂–∞—Ç–∏—è –∫–Ω–æ–ø–æ–∫. –ï—Å–ª–∏ —Ä–∞–∑–Ω–∏—Ü–∞ –±–æ–ª–µ–µ 20 –º–∏–Ω, —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä—É–µ–º
      const cartTime = await this.checkMenuLifeTime(ctx)
      // –ï—Å–ª–∏ –Ω–∏—á–µ–≥–æ –Ω–µ –≤–µ—Ä–Ω—É–ª–∏, –∑–Ω–∞—á–∏—Ç —É–∂–µ –∑–∞–∫—Ä—ã—Ç–æ
      if(!cartTime) return this.isUdate
      // –í—ã–ø–æ–ª–Ω—è–µ–º –æ–ø–µ—Ä–∞—Ü–∏—é –ø–æ —Ä–∞—Å—á—ë—Ç—É –≤—Ä–µ–º–µ–Ω–∏ –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç –Ω–∞–∂–∞—Ç—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º –∫–Ω–æ–ø–æ–∫
      const updatedTime = this.changeTime(cartTime, timeUnit, operator)
      // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –∑–Ω–∞—á–µ–Ω–∏–µ –ø–æ–ø–∞–¥–∞–µ—Ç –≤ –ø–µ—Ä–∏–æ–¥ –≤—Ä–µ–º–µ–Ω–∏ —Ä–∞–±–æ—Ç—ã
      const isUpdate = this.checkOpeningTime(updatedTime, ctx)
      if(isUpdate) {
         // –ï—Å–ª–∏ –≤—Å—ë –Ω–æ—Ä–º, –æ–±–Ω–æ–≤–ª—è–µ–º –≤—Ä–µ–º—è –≤ —Å–µ—Å—Å–∏–∏, –∏ —Å—Ç–∞–≤–∏–º —Ñ–ª–∞–≥, —á—Ç–æ –Ω–∞–¥–æ –æ–±–Ω–æ–≤–∏—Ç—å –º–µ–Ω—é
         ctx.session.cart.time = new Date(updatedTime)
         if(operator === 'plus' && ctx.session.cart.day === 'day_near') {
            ctx.session.cart.day = 'day_today'
         }
         this.isUdate = true
      }
      return this.isUdate
   }
   async updateDay(selectedDay, ctx) {
      this.isUdate = false
      const dayId = `day_${selectedDay}`
      if(selectedDay == 'tomorrow') {
         ctx.session.cart.day = dayId
         this.isUdate = true
      }
      if((selectedDay == 'near') || (selectedDay == 'today')) {
         const currentTime = new Date()
         const currentPlus = currentTime.setMinutes(currentTime.getMinutes() + 20)
         const isUpdate = this.checkOpeningTime(currentPlus, ctx)
         if(isUpdate) {
            ctx.session.cart.time = new Date(currentPlus)
            ctx.session.cart.day = dayId
            this.isUdate = true
         }
      }
      return this.isUdate
   }
   // –û–ø–µ—Ä–∞—Ü–∏–∏ —Å–æ –≤—Ä–µ–º–µ–Ω–µ–º –ø—Ä–∏ –Ω–∞–∂–∞—Ç–∏–∏ –Ω–∞ –∫–Ω–æ–ø–∫–∏
   changeTime(current, timeUnit, operator) {
      if(timeUnit === 'hours') {
         if(operator === 'plus') {
            return current.setHours(current.getHours() + 1)
         }
         if(operator === 'minus') {
            return current.setHours(current.getHours() - 1)
         }
      }
      if(timeUnit === 'minutes') {
         if(operator === 'plus') {
            return current.setMinutes(current.getMinutes() + 10)
         }
         if(operator === 'minus') {
            return current.setMinutes(current.getMinutes() - 10)
         }
      }
   }
   // –§–û–†–ú–ò–†–û–í–ê–ù–ò–ï –ö–ù–û–ü–û–ö –ú–ï–ù–Æ
   // –§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –ø–µ—Ä–µ–¥ –≤—ã–≤–æ–¥–æ–º –≤ –º–µ–Ω—é
   getFormatedTime(ctx) {
      const cartTime = new Date(ctx.session.cart.time)
      return {
         hours: cartTime.getHours().toString().padStart(2, '0'),
         minutes: cartTime.getMinutes().toString().padStart(2, '0')
      }
   }
   // –ù–∞ –∫–∞–∫–æ–π –¥–µ–Ω—å
   dayViewButton(ctx) {
      const { day } = ctx.session.cart
      const btnData = []
      const variants = [
         { name: '–ë–ª–∏–∂–∞–π—à–µ–µ', id: `day_near` },
         { name: '–ü–æ–∑–∂–µ', id: `day_today` },
         { name: '–ó–∞–≤—Ç—Ä–∞', id: `day_tomorrow` }
      ]
      for (let toDay of variants) {
         btnData.push({
            text: day === toDay.id ? `üü¢ ${toDay.name}` : `üîò ${toDay.name}`,
            callback_data: toDay.id
         })
      }
      return btnData
   }
   // –ù–∞ –∫–∞–∫–æ–µ –≤—Ä–µ–º—è
   timeViewButton(ctx) {
      const { hours, minutes } = this.getFormatedTime(ctx)
      return [
         {
            text: `${hours} : ${minutes}`, callback_data: `time`
         }
      ]
   }
   // –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —á–∞—Å–∞–º–∏
   buttonsData(ctx) {
      return [
         [
            {
               text: '-', callback_data: `h_minus`
            },
            {
               text: '+', callback_data: `h_plus`
            },
            {
               text: '–í–†–ï–ú–Ø', callback_data: `time`
            },
            {
               text: '-', callback_data: `m_minus`
            },
            {
               text: '+', callback_data: `m_plus`
            },
         ],
         this. timeViewButton(ctx),
         this.dayViewButton(ctx),
         [
            {
               text: '–ó–ê–ö–ê–ó –ü–û–î–¢–í–ï–†–ñ–î–ê–Æ üëç', callback_data: `place_order`,
            }
         ],
      ]
   }
   // –û–ë–©–ï–ï
   // –£—Å—Ç–∞–Ω–æ–≤–∫–∞ —Ç–µ–∫—É—â–µ–≥–æ –≤—Ä–µ–º–µ–Ω–∏ –≤ —Å–µ—Å—Å–∏—é
   async setDefaultTime(ctx) {
      const serverTime = new Date();
      const currentTimePlus = new Date(serverTime.getTime() + 20 * 60000)
      if(currentTimePlus > this.openingHours.to) {
         ctx.session.cart.time = this.openingHours.from
         ctx.session.cart.day = 'day_tomorrow'
         return
      }
      if(currentTimePlus < this.openingHours.from) {
         ctx.session.cart.time = new Date(this.openingHours.from.getTime() + 20 * 60000)
         ctx.session.cart.day = 'day_today'
         return
      }
      ctx.session.cart.time = currentTimePlus
      ctx.session.cart.day = 'day_near'
   }
   // –í—Ä–µ–º—è —Ä–∞–±–æ—Ç—ã
   get openingHours() {
      return {
         from: this.formatterHoursMinutes(12, 0),
         to: this.formatterHoursMinutes(23, 0),
      }
   }
   // –§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –≤—Ä–µ–º–µ–Ω–∏ —Ä–∞–±–æ—Ç—ã
   formatterHoursMinutes(h, m) {
      const currentTime = new Date()
      currentTime.setHours(h)
      currentTime.setMinutes(m)
      return currentTime
   }
   // –§–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏–µ —Ç–µ–∫—Å—Ç–∞ –≤—Å–µ–≥–æ –∑–∞–∫–∞–∑–∞
   async totalOrderTextCalc(ctx) {
      let orderText = ''
      let totalSumm = null
      const { products } = ctx.session.cart
      for (let cartProduct of products) {
         const { price, name } = await this.productsRepo.findByCartId(cartProduct.id)
         const sumBerProduct = cartProduct.col * price
         totalSumm += sumBerProduct
         orderText += `<b>${name}: ${cartProduct.col} –ª.</b>\n–°—É–º–º–∞: ${sumBerProduct} —Ä—É–±. (${price} —Ä—É–±./–ª–∏—Ç—Ä)\n---\n`
      }
      orderText += `üí≥ –ö –û–ü–õ–ê–¢–ï: ${totalSumm} —Ä—É–±.`
      return orderText
   }

   get cbAnswer() {
      const onlyAuthUsers = '–û—Ñ–æ—Ä–º–ª–µ–Ω–∏–µ –æ–Ω–ª–∞–π–Ω –∑–∞–∫–∞–∑–∞ –¥–æ—Å—Ç—É–ø–Ω–æ —Ç–æ–ª—å–∫–æ —É—á–∞—Å—Ç–Ω–∏–∫–∞–º –±–æ–Ω—É—Å–Ω–æ–π –ø—Ä–æ–≥—Ä–∞–º–º—ã.\n–î–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ —Å—Ç–∞—Ç—É—Å–∞, –Ω–∞–∂–º–∏—Ç–µ –Ω–∞ –∫–Ω–æ–ø–∫—É "–ü–û–î–¢–í–ï–†–î–ò–¢–¨ –¢–ï–õ–ï–§–û–ù"'
      const stopTapAround = '–î–ª—è —É—Å—Ç–∞–Ω–æ–≤–∫–∏ –≤—Ä–µ–º–µ–Ω–∏ –≤–æ—Å–ø–æ–ª—å–∑—É–π—Ç–µ—Å—å –∫–Ω–æ–ø–∫–∞–º–∏ [+] [-]'
      return { onlyAuthUsers }
   }
}